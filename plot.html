<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 15px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.overlay {
  fill: none;
  pointer-events: all;
}

.focusMarkers circle {
  fill: none;
  stroke: steelblue;
}


/*.area {
  fill: none;
  opacity: .9;
  clip-path: url(#clip);
}*/

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}


.path_prob_now {
	fill:none;
    stroke:green;
    stroke-width:1px;
}
.path_prob_5 {
	fill:none;
    stroke:red;
    stroke-width:1px;
}

.path_prob_15 {
	fill:none;
    stroke:blue;
    stroke-width:1px;
}

</style>


<body>


<p>
  <label for="nAge" >
<!--          style="display: inline-block; width: 340px; text-align: right" -->
         Age = <span id="nAge-value">…</span>
  </label>
  <input type="range" min="5" max="100" id="nAge">
</p>


<p>
  <label for="nGender" >
<!--          style="display: inline-block; width: 340px; text-align: right" -->
         Gender = <span id="nGender-value">…</span>
  </label>
  <input type="range" min="0" max="1" id="nGender">
</p>


<script src="http://d3js.org/d3.v3.js"></script>



<script>



var intercept = -7.3381
var bmibeta = .0953
var agebeta = .0491
var malebeta = .3775
var pdata = ['prob_now', 'prob_5','prob_15'];

bmi_values =  [10,11,12,13,14,15,16,17,18,18.5,19.0,19.5,20.0,
				20.5,21.0,21.5,22.0,22.5,23.0,23.5,24.0,24.5,25.0,
				25.5,26.0,26.5,27.0,27.5,28.0,28.5,29.0,29.5,30.0,
				30.5,31.0,31.5,32.0,32.5,33.0,33.5,34.0,34.5,35.0,
				35.5,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,
				51,52,53,54,55,56,57,58,59,60,61,62,63,64,65]

default_age = 25
default_is_male = 1
defaultGenderText = "male"




data = [];

  d3.select("#nAge-value").text(default_age);
  d3.select("#nAge").property("value", default_age);


  d3.select("#nGender-value").text(defaultGenderText);
  d3.select("#nGender").property("value", default_is_male);



  data = buildData(default_age,default_is_male);




	function buildData(age,gender) {
		data = []
		bmi_values.forEach(function(element) {

			var prob_now_calc = 1/(1 + Math.exp(-(intercept+bmibeta*element+agebeta*age+malebeta*gender)))
			var prob_5_calc = 1/(1 + Math.exp(-(intercept+bmibeta*element+agebeta*(age+5)+malebeta*gender)))
			var prob_15_calc = 1/(1 + Math.exp(-(intercept+bmibeta*element+agebeta*(age+15)+malebeta*gender)))

			var bmi_value_object = {'bmi':element,
								'prob_now':prob_now_calc,
								'prob_5':prob_5_calc,
								'prob_15':prob_15_calc};

			data.push(bmi_value_object);

		});

		return data;

	};






// when the input range changes update the graphs
d3.select("#nAge").on("input", function() {
	default_age = +this.value;
  	update(default_age,default_is_male);
});


// when the input range changes update the graphs
d3.select("#nGender").on("input", function() {
	default_is_male = +this.value;

	if (default_is_male == 1) {
		defaultGenderText = "male"
	} else {
		defaultGenderText = "female"
	}


  	update(default_age,default_is_male);
});


// update the elements
function update(nAge,nGender) {
  // adjust the text on the range slider
  d3.select("#nAge-value").text(nAge);
  d3.select("#nAge").property("value", nAge);

  d3.select("#nGender-value").text(defaultGenderText);
  d3.select("#nGender").property("value", default_is_male);

  data = buildData(default_age,default_is_male);


  focus.selectAll("path.focusdata").attr("d", function (prob_when) { 
  	  return areaMain(prob_when)(data);  
  });

  context.selectAll("path.contextdata").attr("d", function (prob_when) { 
  	  return areaBrush(prob_when)(data);  
  });

  	xmain.domain(d3.extent(data, function(d) { return d.bmi; }));
  	y_axis_range = d3.extent(data, function(d) { return d.prob_15; });
  	ymain.domain(y_axis_range);
  	xbrush.domain(xmain.domain());
  	ybrush.domain(ymain.domain());
	focus.select(".x.axis").call(xAxis);

	//y axis...
	//focus.select(".y.axis").call(yAxis);

}















// svg helpers
function brushed() {
	xmain.domain(brush.empty() ? xbrush.domain() : brush.extent());

	var dataFiltered = data.filter(function(d, i) {
		if ( (d.bmi>= xmain.domain()[0]) && (d.bmi <= xmain.domain()[1]) ) {
	    	return d.prob_15;
	    }
	})
	  
	var max = d3.max(dataFiltered.map(function(d) { return d.prob_15; }));

	if (typeof max === "undefined") {
		ymain.domain(brush.empty() ? ybrush.domain() : y_axis_range);
	} else {
		y_axis_range = [0, max*1.1]
		ymain.domain(brush.empty() ? ybrush.domain() : y_axis_range);
	}

	focus.selectAll("path.focusdata").attr("d", function (prob_when) { 
		return areaMain(prob_when)(data); 
	});

	focus.select(".x.axis").call(xAxis);
	focus.select(".y.axis").call(yAxis);
}


var areaMain = function (prob_when) {
	return d3.svg.area()
    	.interpolate("monotone")
    	.x(function(d) { 
    		return xmain(d.bmi); })
    	.y0(height)
    	.y1(function(d) { 
    		return ymain(d[prob_when]); 
    });
};


var areaBrush = function (prob_when) {
	return d3.svg.area()
    	.interpolate("monotone")
    	.x(function(d) { return xbrush(d.bmi); })
    	.y0(height2)
    	.y1(function(d) { return ybrush(d[prob_when]); 
    });
};





//build our canvas

var margin = {top: 10, right: 60, bottom: 155, left: 40},
	margin2 = {top: 375, right: 60, bottom: 20, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom,
    height2 = 500 - margin2.top - margin2.bottom;


var xmain = d3.scale.linear().range([0, width]);
var	xbrush = d3.scale.linear().range([0, width]);

var ymain = d3.scale.linear().range([height, 0]);
var	ybrush = d3.scale.linear().range([height2, 0]);

var xAxis = d3.svg.axis().scale(xmain).orient("bottom");
var	xAxis2 = d3.svg.axis().scale(xbrush).orient("bottom");

var yAxis = d3.svg.axis()
    .scale(ymain)
    .orient("left");

var brush = d3.svg.brush()
    .x(xbrush)

    .on("brush", brushed);


var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

svg.append("defs").append("clipPath")
    .attr("id", "clip")
  .append("rect")
    .attr("width", width)
    .attr("height", height);


svg.append("defs").append("clipPath")
    .attr("id", "clip")
  .append("rect")
    .attr("width", width)
    .attr("height", height);


var focus = svg.append("g")
    .attr("class", "focus")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var context = svg.append("g")
    .attr("class", "context")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");




  xmain.domain(d3.extent(data, function(d) { return d.bmi; }));
  y_axis_range = d3.extent(data, function(d) { return d.prob_15; });
  ymain.domain(y_axis_range);
  xbrush.domain(xmain.domain());
  ybrush.domain(ymain.domain());


  focus.selectAll('path')
    .data(pdata)
  .enter()
    .append('path')
    .attr('clip-path', 'url(#clip)')
    .attr('d', function (prob_when) {
      return areaMain(prob_when)(data);
    })
    .attr('class', function (prob_when) {
      return "path_" + prob_when + " focusdata";
    });

  context.selectAll('path')
    .data(pdata)
  .enter()
    .append('path')
    .attr('clip-path', 'url(#clip)')
    .attr('fill','none')
    .attr('d', function (prob_when) {
      return areaBrush(prob_when)(data);
    })
    .attr('class', function (prob_when) {
      return "path_" + prob_when + " contextdata";
    });




  focus.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .append("text")
    	.attr("class", "x label")
    	.attr("x", width*.99)
    	.attr("y", -6)
    	.style("text-anchor", "end")
        .text("BMI");

  focus.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "y label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".75em")
      .style("text-anchor", "end")
      .text("Prob(DM)");









  context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);

  context.append("g")
      .attr("class", "x brush")
      .call(brush)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height2);









  // THIS CODE SHOWS THE VALUES OM THE LINE    
  var bisectBMI = d3.bisector(function(d) { return d.bmi; }).left
  var formatProb = d3.format(",.2f")
  var formatBMI = d3.format(",.1f")


  //var focusMarkers = svg.append("g")
  var focusMarkers = focus.append("g")
      .attr("class", "focusMarkers")
      .style("display", "none");

  focusMarkers.append("circle")
      .attr("r", 6);

  focusMarkers.append("text")
      .attr("x", 9)
      .attr("dy", ".35em");

  //svg.append("rect")
  focus.append("rect")
	  .attr("class", "overlay")
	  .attr("width", width)
	  .attr("height", height)
	  .on("mouseover", function() { focusMarkers.style("display", null); })
	  .on("mouseout", function() { focusMarkers.style("display", "none"); })
	  .on("mousemove", mousemove);

  function mousemove() {
    var x0 = xmain.invert(d3.mouse(this)[0]),
        i = bisectBMI(data, x0, 1),
        d0 = data[i - 1],
        d1 = data[i],
        d = x0 - d0.bmi > d1.bmi - x0 ? d1 : d0;
    focusMarkers.attr("transform", "translate(" + xmain(d.bmi) + "," + ymain(d.prob_now) + ")");
    focusMarkers.select("text").text("BMI: " + formatBMI(d.bmi) + " Prob: " + formatProb(d.prob_now));
  }


</script>
